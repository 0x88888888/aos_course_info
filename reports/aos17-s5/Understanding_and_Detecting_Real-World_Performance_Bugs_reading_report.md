# Understanding and Detecting Real-World Performance Bugs
----------
### 程阳 2016310575
----------

## 主要工作
追求更高的性能是各界的共同目标，越来越多的方法和研究在关注着系统的性能，本文的主要关注点是系统性能方面的bug的研究，作者关注了商业中常见软件如Apache，Moailla，GCC&LIBS，MYSQL等一些开源的软件，通过分析其中包含的一些系统性能上的bug，以及相关的补丁，分析了相关bug产生的主要原因、补丁的解决方案，并总结其中包含的通用现象和规律，提出了一套 **基于规则** 的范例模型，通过探索相关bug之间的共性和相关性等，期望获得一套发现和解决性能方面bug的方法。利用该方法，在Apache、moazilla、MySQL等优秀开源软件中检测出了许多已经被发现的bug，同时也测试出了需要潜在的性能方面的bug。

在研究系统功能方面的bug和其解决方案比较丰富，但是关注系统性能方面的bug则比较少，作者在研究和解决系统性能方面的bug起到了先例的作用，由于计算系统趋于复杂化，同时具有新旧交替的特性，很多的性能方面的bug隐藏在许多优秀的软件中，在计算需求日益丰富的今天，及时解决系统性能方面的bug越来越得到各界的关注，作者在此方面的一次踊跃尝试，为后面更多在系统性能bug方面的研究打下了基础。
## 相关工作
在以往的工作中，更多的人主要关注的是如何解决系统功能方面的bug，在系统性能方面的研究则比较少，但是主要集中在高性能计算（HPC）、性能诊断工具、性能测试、功能检测和纠正等。

**高性能计算：** 正如其名字所示，高性能计算主要集中于系统的性能，需要优秀的高性能计算检测工具被开发和设计出来，如避免互斥锁的开销等，分布式计算提高系统的整体吞吐量等等，理解高性能计算的原理对于探索系统性能bug方面有很重要的意义。

**性能诊断：** 性能诊断工具也是常常用于分析和提高系统能能的主要工具和方法，需要优秀的工作也在围绕这些展开，在Linux系统中常用与检测和分析系统性能的工具如perf等，在perf的使用中，常常需要用户自己分析程序各个部分的开销，如CPU资源的占有率，锁机制的时间开销等等，这种性能诊断工具只是提供了各个部分的时间开销，并能有给出具体的实现消耗细节，因此作者在此基础上，进一步的深入研究，希望能够做出一个可以自动发现性能bug的方法。

**性能测试：** 性能测试主要包括系统压力测试，也有很多的压力测试如fuzzy测试等围绕这些展现开来，相关的研究工作已经得到关注，但是许多的性能测试工具将系统对待为一个黑盒子，同时需要用户自己构造测试用例，因此显得非常低效，而且不适合用于系统性能bug的发现。

**功能纠正工具：** 需要研究系统功能bug的工作也在关注系统性能的bug，N. Palix, G. Thomas, S. Saha, C. Calves等人提出了一种基于语义补丁的工作，为程序设计人员提供一种自动化的补丁编写、定位和修复方法，但是这种基于语义的补丁修复方法并不能提供一种数据类型检查和数据结构的检查，同时该工具主要工作的C语言模式下，因此不适合用于本文的数据类型检查工具。
## 主要挑战
和系统功能方面的bug不同，系统性能方面的bug检查更加复杂。

**性能bug量化的指标困难：** 不同于系统功能的bug，功能bug可以完整的按照黑盒测试，通过测试用例的输入输出以及期望输入和输出之间的比较，可以找到很快的找到系统功能bug，对于系统性能方面的bug，则没有一个良好的量化指标，因此对于检测来说，比较困难，使用模糊测试也很困难。

**存在周期长：** 不同于系统功能方面的bug，研究表明系统性能方面的bug存在的平均周期更长，而且由于系统的更新和功能bug修复，也会引入新的bug，因此很多bug是由于后期维护时候引入的，且都十分的隐蔽，这些bug不易被发现，同时容易具有比较复杂的触发条件，因此对于这些bug来说，其存在的生命周期比传统功能bug长很多。

**触发条件复杂：** 许多性能方面的bug都存在比较复杂的触发条件，对于同一个输入，在不同环境条件下，也会产生不一样的效果，对于某些常规环境，其可能不是一个性能bug，但是对于满足某些特定上下文的环境中，其就会造成一个性能方面的bug，这样的bug检测比传统bug检测困难很多，这也是类似的性能bug存在周期长，不易被发现的主要原因。

在以前的系统设计中，人们更加关注的是系统功能方面的bug，对于系统性能方面存在的bug没有相关深刻的研究，一方面由于研究系统性能bug面临更加复杂的环境，同时也缺乏相关优秀成熟的研究方法，但是随着对系统性能方面的要求逐渐提高，越来越多人关注与系统性能方面的研究，因此对于研究系统bug方面存在比较大的挑战。
## 研究方法
作者首次提出了系统性能bug研究工作，作者的主要研究方法分为两个部分：广泛收集、研究和总结性能bug的特点和分析其中形成的原因，提出基于规则的bug检测方法。
#### 性能bug的主要表现
>**不一致的功能：** 很多bug是由于一系列的高效函数的低效调用关系导致的，如moazilla中的BookMark的调用。

>**可略过的功能：** 一部分bug是由于重复调用导致，如一个典型的例子是空的循环便利等。

>**同步问题：** 有一部分的bug是由于异步问题导致，由于程序设计的缺陷，需要程序员使用random函数代替同步消息机制，导致了系统同步问题，进一步降低系统的性能，如MySQL中存在大量的这样问题。

#### 造成bug的主要原因
>**负载的错误匹配：** 现代软件的动态和多样化的工作量会导致很多的性能bug，如输入范例通常是根据代码实现之后产生的，因此没有考虑到具体细节情况；软件的工作负载随着软件的复杂化和多样化变化变得更加不确定；

>**API的错误理解：** 许多的开发设计者不能很好地理解API，对于API的错误使用也是造成系统性能bug的一个主要因素：如错误地使用random函数实现同步问题；现在代码的封装以及相关函数的性能要求说明不明确等导致API理解偏差等；

>**bug具有时间局部：**需要性能bug在一开始的时候并不是bug，或许是由于某些特殊的编程技巧等，随着系统升级，部分代码发生变化，因此会引入一个性能bug等。
#### 性能bug修复方法
常见的性能bug具有一定的特点，作者研究了需要性能bug的修复方法，其中呈现主要特征如下：
>**改变调用顺序** 需要性能bug可以调整合适的调用顺序进行修复

>**改变条件** 一部分的bug可以通过改变外在的输入条件避免

>**改变参数** 很多的bug可以简单地通过改变一个参数修复

#### 基于规则bug检测方法
基于规则的抽取方法也是用于检测系统功能bug和系统漏洞的主要方法，其主要是基于以下假设：
>效率规则是存在的

>效率规则能够从补丁中抽取

>效率规则具有一定的普适性

通过总结前面的常见性能bug以及上述的规则，研究了常见性能bug和其补丁之间的关系，抽取了如下规则：
>调用顺序关系

>参数和返回值

>调用上下文环境

## 实验分析
通过研究常见bug和补丁之间的关系，研究和训练上述的关系，得到了一些关系用于检测bug的规则。并用于实验。

**实验环境：**
使用Python和Linux系统以及8核的志强处理器

**实验方法：** 
抽取含有原始补丁和源码之间的上述规则，同时检测最新版的含有补丁的软件，并发现其中是否包含隐藏的bug以及能否检测出修复的bug等。

**实验结果：**
在原始版本中发现了125个潜在的bug，同时跟踪最新版本发现113个bug并没有被修复，此外还检测出了219个潜在的新的性能bug。

## 总结思考
作者关注了系统性能方面bug，通过广泛研究系统性能bug的特点，表现以及分析了其中bug的存在原因以及触发条件等，总结出了性能bug的一些特点，并提出了基于规则的检测方法，用于检测性能bug，具有比较好的应用效果。

作者在系统性能bug检测方面做了开创性工作，存在着一些不足，其总结的bug方法具有较强的局部性和主观色彩，只能覆盖一小部分的样例和上下文环境，对于更多的潜在bug存在更加复杂的环境可能还不能适用，个人觉得可以考虑用机器学习的方法进行规则的发现，以期望找到更多更复杂的bug和环境。另一方面，对于这些潜在的bug，作者并没有给出详细的论证，也没有一个好的说明，因此这一步还需要改进。

除了以上部分，作者这一原创性工作还是很值得肯定的，为性能bug的检测开创了先河。
