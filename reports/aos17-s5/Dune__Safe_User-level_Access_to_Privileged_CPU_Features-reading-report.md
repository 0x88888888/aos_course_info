# Dune: Safe User-level Access to Privileged CPU Features
---
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在现代操作系统中，普遍分为内核态和用户态，在内核态中，一般运行操作系统的内核，为用户的程序提供服务和资源的管理，系统处于这一状态能够进行有效的资源管理和调度，执行一些操作系统的特权指令，以及处理各种异常等；而用户的程序运行在用户态，用户态程序当需要执行某些资源时，通过系统调用，陷入内核态，将控制权限交给内核，从而完成一些特定的资源请求。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;将操作系统分为内核态和用户态，内核态为用户态程序能够有效的保护系统的安全性，特别的对于运行不安全的用户程序，限制其调用特权指令也能进一步阻止造成更大的破坏，但是这种系统调用的代价也是较大的，对于资源有限和高并发的应用来说，性能并不能得到很好的满足。基于此，很多优化的工作已经在硬件上实现了，其中最著名的就是intel的VT-D技术，通过对硬件的虚拟化，是的程序能够访问到硬件资源，提高了性能的吞吐。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;虽然硬件提供了很多的接口，但是依然被操作系统接管，普通的用户程序依然无法直接使用。Dune为普通的应用程序提供高效和安全的访问特权的硬件特性核。它通过利用现代虚拟化硬件,使能够在普通状态下直接执行特权指令。Dune是实现在Linux平台，并使用英特尔提供的虚拟化架构为用户级应用提供全部硬件访问的特性，包括访问异常,虚拟内存,和特权模式等特性。这些特性的引入，使得用户程序能够得到较大的性能提升。同时，Dune对于linux环境的少有修改，保证了系统的兼容性和安全性，使得扩展和实用性得到了极大的提升。

>* 访问异常：普通的用户程序访问异常，需要一个较高的特权优先级，然而Dune为利用了VT-x技术直接将信号传递给硬件，避免了系统调用的开销。
>* 虚拟内存：Dune为用户提供访问页表的实体，并能有效的管理内存地址的转换，权限管理，修改/访问位设置等。
>* Dune利用VMX no-root模式能够为用户直接进入特权模式的访问，和系统调用相比较，能够极大提高系统的性能。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Dune包含了一个内核模块，用于管理VT-x以及和用户程序的交互。通过VMX状态的转换，能够使运行于ring3上的用户程序切换到运行于ring0上的模块，再利用VT-x技术，直接获得硬件访问的权限，避免了通过系统调用，陷入内核等大量的开销。此外，Dune还为用户程序提供了一个用户态的运行库，用户程序通过调用该库，获得相应的资源，实现了一个快速的资源访问。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;和传统虚拟机相比较，Dune只为用户程序提供了硬件的接口抽象，并不是全部的机器特性，因此无法独立运行操作系统程序，但同时，也会使得Dune具有较轻巧的结构在运行速度上，远比虚拟机要快一些。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dune中一个重要的 模块是内存管理，Dune通过查询内核的内存映射，并利用KVM中的MMU hook技术，手动更新用户的内存地址映射，以完成用户程序的地址管理。在为用户程序提供硬件抽象的同时，Dune能够保持和原有的系统调用完美兼容。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在系统调用的测试中，可以看到Dune能够显著的提高了系统的安全性的同时，还能很好地保证了系统的性能。以对TLB缺失测试中，对比linux，Dune系统性能额外的开销仅有极少数的增长，通过优化一个改进的VMX模型，Dune系统能够显著的降低系统调用的开销（180/13592）

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;同时对用户程序进行测试，包括沙盒测试，特权分离测试系统和垃圾收集器。
>* 在沙盒测试中：同归分别运行SPEC2000系统和lighthttp程序在linux系统和Dune系统，以及VMplayer。通过建立HTTP连接，DUne下的吞吐量和linux下的吞吐量差距不大（仅仅2%的性能丢失，由于产生了较多的系统调用），并且远远优越于VMplayer（产生了额外67%的开销和70%的延时，由于经过了两层协议栈）。
>* 在Wedege测试中，分别测试了特权级分离和上下文切换的速度。对比传统的linux下系统，Dune系统在线程（fork）创建时候，能够提供40倍的加速，以及在上下文切换中，提供3倍的性能加速。而Wedge在线程创建时，只能达到12倍的性能加速，并且没有提高上下文的切换。此外在代码实现方面，对比Wedge系统，Dune系统极大的简化了开发，提高了效率。
>* 垃圾回收测试中，Dune通过改进Boehm GC系统实现垃圾回收的功能，同时提供了Dune TLB和Dune Dirty三个不同版本，分别对GCbench，Linked list，Hash Map，XML parser测试集进行测试。对比内存使用和执行时间方面，都具有较大性能的提升。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dune在能够保证和linux系统兼容的同时，创造性地为用户程序提供了硬件资源的访问，是的用户程序能够实现更快，更安全的运行。Dune搭建了一个简单的系统原型，但还有很多未来研究工作可以继续展开。
>* 提供更多硬件资源的访问，包括IO和net方面的扩展，比如IOMMU，SRIOV等。
>* Dune实现了简单单线程的版本，对于多线程和多核性能的支持，目前还在进一步研究中。
>* Dune目前仅仅能支持intel和AMD的主流处理器，对于ARM等其他的系统支持还在研究中。
>* Dune仅仅提供了较简单的系统调用替代，对于其他的系统调用，还需要进一步的研究。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dune在为用户程序提供硬件的访问方面的工作，为我们提供了新的研究思路。虽然功能还不够完善，同时还有很多研究的工作可以基于此展开。
