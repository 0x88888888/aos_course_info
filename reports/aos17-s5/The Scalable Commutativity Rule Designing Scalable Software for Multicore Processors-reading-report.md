# The Scalable Commutativity Rule Designing Scalable Software for Multicore Processors

## 解决问题
本文主要研究的是系统的接口对软件扩展性的影响。纵观现在的系统设计，在处理器处理能力限制的情况下，扩展的分布式系统便成为提高系统性能的主要方式，如何实现这样的扩展性，使得性能提升随着硬件扩展提升呈现线性的比例一直是一个主要的研究方向。理论上，随着硬件的扩展，系统的性能实现等比提升，是合理的，然而在实际的使用中，无论系统怎样的实现，都无法达到理想的效果，那么就会进一步思考问题的所在了：既然在设计上已经达到了最优，依然达不到预期的效果，那接口的设计中是不是就蕴含了一些天然的限制，使得无论怎样实现， 都无法突破这些天然限制？

基于此，作者大量分析了接口设计的原理和思想，提出了接口的可扩展性设计应该和实现独立出来，并站在一个更高的阶层探测接口设计的扩展性问题，并编写了一个称为COMMUTER的工具, 以及一个原型操作系统SV6. 实验表明对COMMUTER产生的13664个测试而言, Linux能对其中的68%良好扩展, 而SV6能良好扩展其中的99%。

## 相关工作
其实在在很多的系统设计中，已经有大量的关于并行和交互之间的关系的研究，很多人尝试利用交换性规则解释系统扩展性的问题，H. Attiya等人尝试用交换性规则解释并行指令执行的安全性，这对作者来说是一个补充和启示。A. Baumann等人定义了交换性规则，并证明了其正确性；
Israeli 和Rappoport等人介绍了 disjoint access-parallel的内存系统，通过共享一个disjoint access-parallel，所有访问的进程能够达到线性的扩展；
Attiya等人扩展了Israeli等人的工作，指出：这样的线性扩展假设需要无冲突才能实现。
H. Attiya提出了顺序的规则，探索了接口强无交互性和实现需要原子操作和类似的隔离。
J. M. Mellor-Crummey等人设计了MCS锁，用于解决线性缓存内容的扩展性，F. Ellen等人利用计数变量解决扩展性等。
还有部分工作利用交换性增加并行性，Steele指出，所有的操作准则要么基于相关性，要么基于交换性。受此启发，我们发现**所有的满足交换性准则都有一个没有冲突的实现**。

此外，还有很多利用符号执行的方法进行测试和验证工作，COMMUTE结合和符号执行和符号测试，生成测试集，覆盖全部的测试情形，使得独立于具体的实现。

## 设计思路
作者提出了SIM交换性规则，不同于传统的交换性规则，SIM是基于状态依赖和基于接口的。当操作在一个特别的上下文（包括参数，并行指令）产生交互时，我们才会说在当前状态、参数和并行指令环境下，是无冲突的。这样就给应用实现接口流出了很多的实现扩展性的空间。
同时SIM也是基于接口的交换规则，不需要要求所有的操作指令都和内部识别状态保持一致，只需要状态能够被接口所区分即可。SIM接口能够区别任何实现，使得设计人员能够应用此规则进行接口设计。

在可交换接口设计方面，考虑到现有的设计耦合度很大，许多都具有较大的粒度，因此作者主要利用了**去耦合**，**允许弱序**，**异步释放资源**等思想，使得具体的功能间交叉最小，以保证满足SIM交换性规则，并基于此进行了接口的设计。

接着，利用开发的工具**COMMUTER**工具进行分析和测试接口的扩展性。接口的扩展性分析包含三个部分：
>* 利用ANALYZER模块进行符号执行抽取主要接口，并计算出测试的全部条件。
>* 利用TESTGEN模块根据上面模块的抽取关系和测试条件生成测试用例，以覆盖全部的测试空间。
>* 利用MTRACE模块进行验证，以检查是否一个具体的实现是无冲突的。

## 验证与分析
为了验证COMMUTER的使用性，作者对对POSIX中文件和虚拟内存接口进行了部分修改，并用COMMUTER进行测试，用于评估LINUX的扩展性，同时还在SV6操作系统上实现了一个可扩展的文件系统和虚拟内存接口。
#### POSIX测试
在POSIX测试汇总，修改了POSIX文件系统和虚拟内存总的18个系统调用，COMMUTER生成了13664个测试用例。测试结果表明很多的POSIX接口标准都存在着访问冲突，这种冲突严重影响到系统的扩展性。
#### 检验当前Linux系统实现的扩展性
作者利用COMMUTER中的MTRACE模块在Linux 内核3.8上的具体实现进行了验证，评估了ramfs文件系统和Linux虚拟内存系统的接口，测试地结果表明，在生成13664个测试用例中，有4275个广泛分布于实际系统中的用例都是有冲突的。

对比Linux中的ramfs文件系统，作者在自己的sv6系统上实现了类似的scaleFS文件系统，和RadixVM虚拟内存管理系统。测试得结果表明按照SIM交换规则设计的接口能够具有很好的线性扩展性。在设计的13664个测试用例中，只有136个是具有冲突的。相对于Linux而言，具有很大的提升。

## 性能评估
作者设计了两组小规模的试验床和应用级测试床，在每组床测试中，包含两个独立的变量：分别是应用标准的（非交换性）POSIX API和基于SIM交换准则设计的完成同样功能的API。
分别在statbench和openbench上进行测试。

##### statbench测试文件链接相关的扩展性
在statbench测试中，测试fast文件系统：利用一半的核创建单个文件，用另一半核链接文件到一个新的不同的文件，然后取消链接。由于fstat在链接和取消链接不满足交换性，因此应用程序调用fstat的速度非常缓慢，在sv6系统中，利用fstatx能够迅速访问文件的某些特定位，具有良好的可交互性。
因此在测试结果中，利用fstat文件系统的测试组随着核数的增加，扩展性显著降低，但是fstatx系统的单核扩展性不会随着核数的增大减少。呈现一个线性的提升。

##### openbench测试文件描述符分配的扩展性
传统的文件描述符分配是基于最小FD分配的，然而这在分析中也表明不具有可交换性，SV6在open函数只能怪增加O_ANYFD属性，使得分配文件描述符随机化，而不是按照最小化FD标签，这样就具有较好的可交换性，因此也具有了较好的可扩展性。在测试得结果中显示：任意分配的FD单核的扩展性具有较好的扩展性，随着核数的增大，单核的能力依然保持不变，但是基于最小化FD标签的文件描述符分配则随着核数增大，单核的处理能力显著降低。
##### 应用程序扩展性能
在应用程序扩展性能分析中，构建了一个基于产生系统调用邮件服务器模型，邮件服务器李永乐一个分离队列机制，实现可交换性处理。
在测试中，具有可交换性的实现方式，单核的吞吐量随着核数的增大，保持不变，但是传统的实现方式，单核的吞吐量则随着核数的增大减小。

## 启发和感悟
我们在很多时候，在设计一个规则时，总是站在一个理想的环境中进行设计，然后在系统的实现时，很难达到我们预期想要的结果，于是，我们很多时候就会给出一个trade-off的解释，系统设计与实现上总是存在一个平衡的问题，当大家都习以为常的时候，很少去探究其中的原理。COMMUTER系统给我们一个启示：在系统实现中，无论如何调整都无法达到理想的期望，是不是可以回过头来调整一下，看看设计方面是不是具有不可扩展性？

系统的设计是一个极其复杂的工程，任何一部分都有可能成为整个的瓶颈，进而影响整体的性能，因此我们必须找出其中的瓶颈部分，为系统的优化找出合适的方向。COMMUTER中的符号执行部分非常的新颖，在分析系统的性能找出瓶颈时，我们很多都是单个单个模块的调试分析，这样在效率上也比较低下，在越来越复杂的工程实践中，越来越不可取，如何有效的利用符号执行来进行输入集合的测试与分析便是一个非常好地方法。

本文的理论分析也十分深刻，这一点也非常值得我们学习。

按照我的想法，对于做一个这种项目来说，首先也需要归纳和总结，然后进行分析和策划，比如作者前边部分的理论分析等工作，找出问题的关键。接着便是设计一个原型，并给出详细的论证和分析，最后进行系统的实现和仿真测试，进一步优化。

## 参考文献
相关参考文献列表：

H. Attiya, R. Guerraoui, D. Hendler, P. Kuznetsov, M. M. Michael, and M. Vechev. Laws of order:Expensive synchronization in concurrent algorithms cannot be eliminated. In Proceedings of the 38th ACM Symposium on Principles of Programming Languages, Austin, TX, January 2011.

A. Baumann, P. Barham, P.-E. Dagand, T. Harris, R. Isaacs, S. Peter, T. Roscoe, A. Schüpbach, and A. Singhania. The Multikernel: A new OS architecture for scalable multicore systems. In Proceedings of the 22nd ACM Symposium on Operating Systems Principles (SOSP), Big Sky, MT, October 2009

F. Ellen, Y. Lev, V. Luchango, and M. Moir. SNZI: Scalable nonzero indicators. In Proceedings of the 26th ACM SIGACT-SIGOPS Symposium on Principles of Distributed Computing, Portland, OR, August 2007.

J. M. Mellor-Crummey and M. L. Scott. Algorithms for scalable synchronization on shared-memory multiprocessors. ACM Transactions on Computer Systems, 9(1):21¨C65, 1991.
